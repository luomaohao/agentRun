# 工作流引擎架构图

## 系统架构总览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          外部接入层 (External Access)                      │
├─────────────────────────────────────────────────────────────────────────┤
│  API Gateway  │  SDK/CLI  │  Webhook  │  Event Triggers  │  Scheduler   │
└───────────────┬─────────────────────┬────────────────────┬──────────────┘
                │                     │                    │
┌───────────────▼─────────────────────▼────────────────────▼──────────────┐
│                        工作流引擎核心 (Workflow Engine Core)              │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────┐  ┌──────────────┐ │
│  │   Parser    │  │   Engine     │  │  Scheduler  │  │State Machine │ │
│  │             │  │              │  │             │  │   Engine     │ │
│  │ • YAML/JSON │  │ • Lifecycle  │  │ • Priority  │  │              │ │
│  │ • Validate  │  │ • Execution  │  │ • Resource  │  │ • Events     │ │
│  │ • Optimize  │  │ • Context    │  │ • Rate Limit│  │ • Transitions│ │
│  └─────────────┘  └──────────────┘  └─────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
                │                     │                    │
┌───────────────▼─────────────────────▼────────────────────▼──────────────┐
│                      节点执行器层 (Node Executors)                       │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────┐  ┌──────────────┐ │
│  │Agent Executor│  │Tool Executor │  │Control Node │  │ Aggregation  │ │
│  │             │  │              │  │  Executor   │  │   Executor   │ │
│  │ • Invoke    │  │ • Call Tools │  │ • Switch    │  │              │ │
│  │ • Validate  │  │ • Validate   │  │ • Parallel  │  │ • Merge      │ │
│  │ • Transform │  │ • Transform  │  │ • Loop      │  │ • Aggregate  │ │
│  └─────────────┘  └──────────────┘  └─────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
                │                     │                    │
┌───────────────▼─────────────────────▼────────────────────▼──────────────┐
│                        集成层 (Integration Layer)                        │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────┐  ┌──────────────┐ │
│  │Agent Runtime│  │Tool Registry │  │ Event Bus   │  │  Monitoring  │ │
│  │             │  │              │  │             │  │              │ │
│  │ • OpenAI   │  │ • HTTP       │  │ • Memory    │  │ • Metrics    │ │
│  │ • Claude   │  │ • Database   │  │ • Kafka     │  │ • Tracing    │ │
│  │ • Custom   │  │ • Email      │  │ • NATS      │  │ • Logging    │ │
│  └─────────────┘  └──────────────┘  └─────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
                │                     │                    │
┌───────────────▼─────────────────────▼────────────────────▼──────────────┐
│                        存储层 (Storage Layer)                            │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────┐  ┌─────────────────────────────────────┐  │
│  │   Workflow Repository    │  │      Execution Repository           │  │
│  │                         │  │                                     │  │
│  │ • Save/Load Workflows   │  │ • Save/Load Executions              │  │
│  │ • Version Management    │  │ • Node Execution States             │  │
│  │ • Query & Search        │  │ • Event Storage                     │  │
│  └─────────────────────────┘  └─────────────────────────────────────┘  │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │                    PostgreSQL / MongoDB                          │  │
│  └─────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
```

## 执行流程图

```
┌──────────┐     ┌─────────┐     ┌──────────┐     ┌────────┐     ┌──────────┐
│  Client  │────▶│  Parse  │────▶│ Validate │────▶│Schedule│────▶│ Execute  │
└──────────┘     └─────────┘     └──────────┘     └────────┘     └──────────┘
                      │                │                │               │
                      ▼                ▼                ▼               ▼
                 ┌─────────┐     ┌──────────┐     ┌────────┐     ┌──────────┐
                 │Workflow │     │  Errors  │     │ Queue  │     │  Nodes   │
                 │  Model  │     │          │     │        │     │          │
                 └─────────┘     └──────────┘     └────────┘     └──────────┘
```

## 数据流图

```
                           ┌─────────────────┐
                           │ Workflow Input  │
                           └────────┬────────┘
                                   │
                           ┌───────▼────────┐
                           │Execution Context│
                           └────────┬────────┘
                                   │
                ┌──────────────────┼──────────────────┐
                │                  │                  │
        ┌───────▼───────┐  ┌──────▼──────┐  ┌───────▼───────┐
        │    Node 1     │  │   Node 2    │  │    Node 3     │
        │               │  │             │  │               │
        │ ┌───────────┐ │  │┌───────────┐│  │ ┌───────────┐ │
        │ │   Input   │ │  ││   Input   ││  │ │   Input   │ │
        │ └─────┬─────┘ │  │└─────┬─────┘│  │ └─────┬─────┘ │
        │       │       │  │      │      │  │       │       │
        │ ┌─────▼─────┐ │  │┌─────▼─────┐│  │ ┌─────▼─────┐ │
        │ │ Executor  │ │  ││ Executor  ││  │ │ Executor  │ │
        │ └─────┬─────┘ │  │└─────┬─────┘│  │ └─────┬─────┘ │
        │       │       │  │      │      │  │       │       │
        │ ┌─────▼─────┐ │  │┌─────▼─────┐│  │ ┌─────▼─────┐ │
        │ │  Output   │ │  ││  Output   ││  │ │  Output   │ │
        │ └───────────┘ │  │└───────────┘│  │ └───────────┘ │
        └───────┬───────┘  └──────┬──────┘  └───────┬───────┘
                │                  │                  │
                └──────────────────┼──────────────────┘
                                   │
                           ┌───────▼────────┐
                           │ Final Output   │
                           └────────────────┘
```

## 状态机执行流程

```
                    ┌─────────────┐
                    │   Start     │
                    └──────┬──────┘
                          │ Event: begin
                    ┌─────▼──────┐
                    │Processing  │◄────────┐
                    └─────┬──────┘         │
                          │                │ Event: retry
                    ┌─────▼──────┐         │
                    │  Decision  │─────────┘
                    └─────┬──────┘
                          │ Event: complete
                    ┌─────▼──────┐
                    │    Done    │
                    └────────────┘
```

## 关键设计特点

### 1. 分层架构
- 清晰的层次划分
- 单向依赖关系
- 易于测试和维护

### 2. 模块化设计
- 每个组件职责单一
- 通过接口通信
- 支持独立扩展

### 3. 异步执行
- 基于 asyncio 的异步架构
- 高效的并发处理
- 非阻塞 I/O 操作

### 4. 可扩展性
- 插件式节点执行器
- 灵活的存储接口
- 可配置的集成选项

### 5. 容错设计
- 多级错误处理
- 自动重试机制
- 状态恢复能力

## 部署架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Load Balancer (Nginx/ALB)                    │
└──────────────────────────────┬──────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
┌───────▼────────┐   ┌────────▼───────┐   ┌────────▼───────┐
│  API Server 1  │   │  API Server 2  │   │  API Server 3  │
│   (FastAPI)    │   │   (FastAPI)    │   │   (FastAPI)    │
└───────┬────────┘   └────────┬───────┘   └────────┬───────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │
┌─────────────────────────────▼──────────────────────────────────────┐
│                          Message Queue                              │
│                      (Kafka/RabbitMQ/NATS)                         │
└─────────────────────────────┬──────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
┌───────▼────────┐   ┌────────▼───────┐   ┌────────▼───────┐
│    Worker 1    │   │    Worker 2    │   │    Worker 3    │
│  (Scheduler)   │   │  (Scheduler)   │   │  (Scheduler)   │
└───────┬────────┘   └────────┬───────┘   └────────┬───────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │
┌─────────────────────────────▼──────────────────────────────────────┐
│                     Database Cluster                                │
│                  (PostgreSQL with Read Replicas)                   │
└─────────────────────────────────────────────────────────────────────┘
```

这个架构设计确保了系统的高可用性、可扩展性和可维护性，为智能体工作流的可靠执行提供了坚实的基础。
